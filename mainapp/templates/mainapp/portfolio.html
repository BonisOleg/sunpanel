{% extends 'mainapp/base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}
{% block description %}{{ description }}{% endblock %}
{% block keywords %}{{ keywords }}{% endblock %}
{% block canonical %}https://greensolartech.com.ua/portfolio/{% endblock %}

{% block page_css %}
<link rel="stylesheet" href="{% static 'css/base.css' %}?v=2025012506">
<link rel="stylesheet" href="{% static 'css/portfolio.css' %}?v=2025012506">
{% endblock %}

{% block content %}
<div class="portfolio-page">
    <div class="portfolio-container">
        <header class="portfolio-header">
            <h1 class="portfolio-title">Портфоліо проєктів</h1>
            <p class="portfolio-subtitle">Реалізовані сонячні електростанції по всій Україні</p>
        </header>

        <!-- Проект 1: Комерційна СЕС -->
        <section class="project-block">
            <div class="project-header">
                <h2 class="project-title">{{ project1.title }}</h2>
                <div class="project-meta-main">
                    <div class="meta-grid">
                        <div class="meta-item">
                            <span class="meta-label">Потужність:</span>
                            <span class="meta-value">{{ project1.power_capacity }} кВт</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Локація:</span>
                            <span class="meta-value">{{ project1.location }}</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Тип проєкту:</span>
                            <span class="meta-value">{{ project1.project_type }}</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Дата завершення:</span>
                            <span class="meta-value">{{ project1.completion_date|date:"j F Y" }}</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Клієнт:</span>
                            <span class="meta-value">{{ project1.client_name }}</span>
                        </div>
                    </div>
                </div>
            </div>

            {% if project1.all_images %}
            <div class="project-gallery">
                <h3 class="gallery-title">Фотогалерея проекту</h3>
                <div class="gallery-grid" data-project="project1">
                    {% for image in project1.all_images %}
                    <div class="gallery-item" data-src="{{ MEDIA_URL }}{{ image }}" data-alt="{{ project1.title }}">
                        <img src="{{ MEDIA_URL }}{{ image }}" alt="{{ project1.title }}" loading="lazy">
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <div class="project-description">
                <h3 class="description-title">Опис проекту</h3>
                <div class="description-content">{{ project1.description|linebreaks }}</div>
            </div>
        </section>

        <!-- Проект 2: Промислова СЕС -->
        <section class="project-block">
            <div class="project-header">
                <h2 class="project-title">{{ project2.title }}</h2>
                <div class="project-meta-main">
                    <div class="meta-grid">
                        <div class="meta-item">
                            <span class="meta-label">Потужність:</span>
                            <span class="meta-value">{{ project2.power_capacity }} кВт</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Локація:</span>
                            <span class="meta-value">{{ project2.location }}</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Тип проєкту:</span>
                            <span class="meta-value">{{ project2.project_type }}</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Дата завершення:</span>
                            <span class="meta-value">{{ project2.completion_date|date:"j F Y" }}</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Клієнт:</span>
                            <span class="meta-value">{{ project2.client_name }}</span>
                        </div>
                    </div>
                </div>
            </div>

            {% if project2.all_images %}
            <div class="project-gallery">
                <h3 class="gallery-title">Фотогалерея проекту</h3>
                <div class="gallery-grid" data-project="project2">
                    {% for image in project2.all_images %}
                    <div class="gallery-item" data-src="{{ MEDIA_URL }}{{ image }}" data-alt="{{ project2.title }}">
                        <img src="{{ MEDIA_URL }}{{ image }}" alt="{{ project2.title }}" loading="lazy">
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <div class="project-description">
                <h3 class="description-title">Опис проекту</h3>
                <div class="description-content">{{ project2.description|linebreaks }}</div>
            </div>
        </section>

        <!-- Проект 3: Приватна СЕС -->
        <section class="project-block">
            <div class="project-header">
                <h2 class="project-title">{{ project3.title }}</h2>
                <div class="project-meta-main">
                    <div class="meta-grid">
                        <div class="meta-item">
                            <span class="meta-label">Потужність:</span>
                            <span class="meta-value">{{ project3.power_capacity }} кВт</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Локація:</span>
                            <span class="meta-value">{{ project3.location }}</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Тип проєкту:</span>
                            <span class="meta-value">{{ project3.project_type }}</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Дата завершення:</span>
                            <span class="meta-value">{{ project3.completion_date|date:"j F Y" }}</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Клієнт:</span>
                            <span class="meta-value">{{ project3.client_name }}</span>
                        </div>
                    </div>
                </div>
            </div>

            {% if project3.all_images %}
            <div class="project-gallery">
                <h3 class="gallery-title">Фотогалерея проекту</h3>
                <div class="gallery-grid" data-project="project3">
                    {% for image in project3.all_images %}
                    <div class="gallery-item" data-src="{{ MEDIA_URL }}{{ image }}" data-alt="{{ project3.title }}">
                        <img src="{{ MEDIA_URL }}{{ image }}" alt="{{ project3.title }}" loading="lazy">
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <div class="project-description">
                <h3 class="description-title">Опис проекту</h3>
                <div class="description-content">{{ project3.description|linebreaks }}</div>
            </div>
        </section>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Змінні для галереї
        let currentProject = null;
        let currentIndex = 0;
        let projectImages = [];
        let lightboxElement = null;

        // Створення lightbox
        function createLightbox() {
            if (lightboxElement) {
                console.log('Lightbox already exists');
                return;
            }

            console.log('Creating lightbox element');
            lightboxElement = document.createElement('div');
            lightboxElement.className = 'lightbox';
            lightboxElement.innerHTML = `
                <div class="lightbox-content">
                    <img class="lightbox-image" src="" alt="">
                    <button class="lightbox-close">&times;</button>
                    <button class="lightbox-nav lightbox-prev">&#8249;</button>
                    <button class="lightbox-nav lightbox-next">&#8250;</button>
                    <div class="lightbox-info">
                        <div class="lightbox-counter"></div>
                        <div class="lightbox-title"></div>
                    </div>
                </div>
            `;
            document.body.appendChild(lightboxElement);
            console.log('Lightbox element created and added to body');

            setupLightboxEvents();
        }

        // Налаштування подій lightbox
        function setupLightboxEvents() {
            // Закриття lightbox
            lightboxElement.addEventListener('click', function (e) {
                if (e.target === lightboxElement || e.target.classList.contains('lightbox-close')) {
                    closeLightbox();
                }
            });

            // Кнопки навігації
            const prevBtn = lightboxElement.querySelector('.lightbox-prev');
            const nextBtn = lightboxElement.querySelector('.lightbox-next');

            if (prevBtn) {
                prevBtn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    showPrevImage();
                });
            }

            if (nextBtn) {
                nextBtn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    showNextImage();
                });
            }

            // Клавіатурна навігація
            document.addEventListener('keydown', function (e) {
                if (!lightboxElement.classList.contains('active')) return;

                switch (e.key) {
                    case 'Escape':
                        closeLightbox();
                        break;
                    case 'ArrowLeft':
                        showPrevImage();
                        break;
                    case 'ArrowRight':
                        showNextImage();
                        break;
                }
            });
        }

        // Відкриття галереї
        function openLightbox(project, index) {
            console.log('Opening lightbox for project:', project, 'index:', index);
            currentProject = project;
            currentIndex = index;

            // Збираємо зображення проекту
            const galleryGrid = document.querySelector(`[data-project="${project}"]`);
            if (!galleryGrid) {
                console.error('Gallery grid not found for project:', project);
                return;
            }

            const galleryItems = galleryGrid.querySelectorAll('.gallery-item');
            console.log('Found gallery items for project:', galleryItems.length);

            projectImages = Array.from(galleryItems).map(function (item) {
                const img = item.querySelector('img');
                const src = item.dataset.src || (img ? img.src : '');
                const alt = item.dataset.alt || (img ? img.alt : '');
                console.log('Image data:', { src, alt });
                return { src, alt };
            });

            if (projectImages.length === 0) {
                console.error('No images found in project:', project);
                return;
            }

            console.log('Project images:', projectImages);

            updateLightboxContent();
            lightboxElement.classList.add('active');
            document.body.classList.add('body-scroll-lock');

            console.log('Lightbox opened, active class added');
        }

        // Оновлення контенту lightbox
        function updateLightboxContent() {
            console.log('Updating lightbox content, current index:', currentIndex);
            if (!lightboxElement || !projectImages[currentIndex]) {
                console.error('Lightbox element or current image not found');
                return;
            }

            const image = lightboxElement.querySelector('.lightbox-image');
            const counter = lightboxElement.querySelector('.lightbox-counter');
            const title = lightboxElement.querySelector('.lightbox-title');
            const prevBtn = lightboxElement.querySelector('.lightbox-prev');
            const nextBtn = lightboxElement.querySelector('.lightbox-next');

            const currentImage = projectImages[currentIndex];
            console.log('Current image:', currentImage);

            if (image) {
                image.src = currentImage.src;
                image.alt = currentImage.alt;
                console.log('Image updated:', currentImage.src);
            }

            if (counter) {
                counter.textContent = `${currentIndex + 1} з ${projectImages.length}`;
            }

            if (title) {
                title.textContent = currentImage.alt;
            }

            // Управління видимістю кнопок навігації
            if (prevBtn) {
                prevBtn.classList.toggle('hidden', currentIndex === 0);
            }

            if (nextBtn) {
                nextBtn.classList.toggle('hidden', currentIndex === projectImages.length - 1);
            }

            console.log('Lightbox content updated successfully');
        }

        // Наступне зображення
        function showNextImage() {
            if (currentIndex < projectImages.length - 1) {
                currentIndex++;
                updateLightboxContent();
            }
        }

        // Попереднє зображення
        function showPrevImage() {
            if (currentIndex > 0) {
                currentIndex--;
                updateLightboxContent();
            }
        }

        // Закриття lightbox
        function closeLightbox() {
            if (lightboxElement) {
                lightboxElement.classList.remove('active');
            }
            document.body.classList.remove('body-scroll-lock');
        }

        // Ініціалізація кліків по галереї
        function initGalleryClicks() {
            const galleryItems = document.querySelectorAll('.gallery-item');
            console.log('Found gallery items:', galleryItems.length);

            galleryItems.forEach(function (item, globalIndex) {
                item.addEventListener('click', function (e) {
                    e.preventDefault();
                    console.log('Gallery item clicked:', globalIndex);

                    const galleryGrid = item.closest('.gallery-grid');
                    if (!galleryGrid) {
                        console.error('Gallery grid not found');
                        return;
                    }

                    const project = galleryGrid.dataset.project;
                    if (!project) {
                        console.error('Project dataset not found');
                        return;
                    }

                    console.log('Opening project:', project);

                    const projectItems = galleryGrid.querySelectorAll('.gallery-item');
                    const projectIndex = Array.from(projectItems).indexOf(item);

                    console.log('Project index:', projectIndex);

                    createLightbox();
                    openLightbox(project, projectIndex);
                });
            });
        }

        // Анімації появи блоків
        function initScrollAnimations() {
            const projectBlocks = document.querySelectorAll('.project-block');

            projectBlocks.forEach(function (block) {
                block.classList.add('project-block-hidden');
            });

            const observerOptions = {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px'
            };

            const observer = new IntersectionObserver(function (entries) {
                entries.forEach(function (entry) {
                    if (entry.isIntersecting) {
                        entry.target.classList.remove('project-block-hidden');
                        entry.target.classList.add('project-block-visible');
                    }
                });
            }, observerOptions);

            projectBlocks.forEach(function (block) {
                observer.observe(block);
            });
        }

        // Ініціалізація всього
        console.log('Portfolio gallery script initialized');
        initGalleryClicks();
        initScrollAnimations();
        console.log('Portfolio gallery initialization complete');
    });
</script>

{% endblock %}