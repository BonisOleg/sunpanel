{% extends 'mainapp/base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}
{% block description %}{{ description }}{% endblock %}
{% block keywords %}{{ keywords }}{% endblock %}
{% block canonical %}https://greensolalrtech.com/reviews/{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/reviews.css' %}">
{% endblock %}

{% block content %}
<main class="reviews-page">
    <div class="container">
        <h1>Відгуки клієнтів</h1>
        <p>Думки наших клієнтів про співпрацю з GreenSolarTech</p>

        {% if messages %}
        {% for message in messages %}
        <div class="message">{{ message }}</div>
        {% endfor %}
        {% endif %}

        {% if average_rating %}
        <div class="stats">
            <strong>{{ average_rating|floatformat:1 }}</strong>
            {% for star in "12345" %}
            {% if forloop.counter <= average_rating %}★{% else %}☆{% endif %} {% endfor %} ({{ total_reviews }}
                відгуків) </div>
                {% endif %}

                <h2>Залишити відгук</h2>
                <form method="post">
                    {% csrf_token %}
                    <div>
                        <label>{{ form.client_name.label }} *</label>
                        {{ form.client_name }}
                        {% if form.client_name.errors %}
                        <span class="error">{{ form.client_name.errors.0 }}</span>
                        {% endif %}
                    </div>

                    <div>
                        <label>{{ form.client_position.label }}</label>
                        {{ form.client_position }}
                    </div>

                    <div>
                        <label>{{ form.location.label }}</label>
                        {{ form.location }}
                    </div>

                    <div>
                        <label>{{ form.project_type.label }}</label>
                        {{ form.project_type }}
                    </div>

                    <div>
                        <label>{{ form.review_text.label }} *</label>
                        {{ form.review_text }}
                        {% if form.review_text.errors %}
                        <span class="error">{{ form.review_text.errors.0 }}</span>
                        {% endif %}
                    </div>

                    <div>
                        <label>{{ form.rating.label }} *</label>
                        <div class="stars" id="stars">
                            <span data-rating="1">★</span>
                            <span data-rating="2">★</span>
                            <span data-rating="3">★</span>
                            <span data-rating="4">★</span>
                            <span data-rating="5">★</span>
                        </div>
                        {{ form.rating }}
                        {% if form.rating.errors %}
                        <span class="error">{{ form.rating.errors.0 }}</span>
                        {% endif %}
                    </div>

                    <button type="submit">Надіслати відгук</button>
                </form>

                {% if reviews %}
                <h2>Відгуки</h2>
                {% for review in reviews %}
                <div class="review">
                    <div class="review-header">
                        <strong>{{ review.client_name }}</strong>
                        {% if review.client_position %} - {{ review.client_position }}{% endif %}
                        <div class="rating">
                            {% for star in "12345" %}
                            {% if forloop.counter <= review.rating %}★{% else %}☆{% endif %} {% endfor %} </div>
                        </div>
                        <p>{{ review.review_text }}</p>
                        <div class="review-info">
                            {% if review.project_type %}Проєкт: {{ review.project_type }} | {% endif %}
                            {% if review.location %}{{ review.location }} | {% endif %}
                            {{ review.created_at|date:"d.m.Y" }}
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <p>Поки що немає відгуків.</p>
                    {% endif %}
                </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const stars = document.querySelectorAll('#stars span');
        const ratingInput = document.querySelector('select[name="rating"]');

        if (stars && ratingInput) {
            ratingInput.style.display = 'none';

            stars.forEach(function (star) {
                star.addEventListener('click', function () {
                    const rating = this.getAttribute('data-rating');
                    ratingInput.value = rating;

                    stars.forEach(function (s, index) {
                        if (index < rating) {
                            s.style.color = '#ffc107';
                        } else {
                            s.style.color = '#ddd';
                        }
                    });
                });
            });
        }
    });
</script>
{% endblock %}